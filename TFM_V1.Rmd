---
title: "TFM_v1"
author: "María Perea"
date: "9 de julio de 2020"
output: html_document
---

#### Importando fichero "Mortality_rate_Newborn_Child.csv"
****IMPORTANDO fichero con el indicador: Selección y cambio de nombre en columnas, creando tabla de Wide a Longer.
```{r}
Rate_Child_all<-read.csv("Mortality_rate_Newborn_Child.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Rate_Child<-Rate_Child_all[ ,c(1,31:59)]
colnames(Rate_Child)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010","2009","2008","2007","2006","2005","2004","2003","2002","2001","2000","1999","1998","1997","1996","1995","1994","1993","1992","1991","1990")

Rate_Child <- Rate_Child %>%
  pivot_longer(cols=`2018`:`1990`,
               names_to="year",
               values_to = "Rate_Mort_Child",
               names_ptypes = list(year=integer()))
glimpse(Rate_Child)
unique(Rate_Child$Who_Region)
unique(Rate_Child$year)
```

#### Análisis indicador Rate_Mort_Child
****Pivotando tabla de Longer a Wide (Regiones en columnas)

```{r}
Rate_Child_wide <- Rate_Child %>%
  pivot_wider(names_from=Who_Region, 
              values_from=Rate_Mort_Child)

stat_wide<-stat.desc(Rate_Child_wide,norm = TRUE)
stat_wide<-round(stat_wide,2)
stat_wide

```

###### Gráficos

```{r}
ggplot(data=Rate_Child,aes(x=Who_Region,y=Rate_Mort_Child))+
  geom_boxplot(aes(fill=Who_Region)) +
  ggtitle("Under-five mortality rate 
          (probability of dying by age 5 per 1000 live births)")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text.x=element_text(angle=90, hjust=1))+
  ylab("per 1000 live births")



ggplot(data=Rate_Child,aes(x=year,y=Rate_Mort_Child))+
  geom_point(aes(col=Who_Region))+
  ggtitle("Under-five mortality rate 
          (probability of dying by age 5 per 1000 live births)")+
  theme(plot.title = element_text(hjust = 0.5))
```


#### Importando fichero "International_Health_Regulations.csv""
**** Contiene 13 indicadores de la Regulación Internacional de Salud(Encuestas)
**** Se importa el fichero seleccionando las columnas de cada indicador
**** Pivotando cada tabla de Wide a Longer


```{r}

Int_Health_Regulat<-read.csv("International_Health_Regulations.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)

#### Legislation
Int_Health_Regulat_Legislation<-Int_Health_Regulat[ ,c(1:9)]
colnames(Int_Health_Regulat_Legislation)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Legislation <- Int_Health_Regulat_Legislation %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Legislation",
               names_ptypes = list(year=integer()))

#### Coordination
Int_Health_Regulat_Coordination<-Int_Health_Regulat[ ,c(1,10:17)]
colnames(Int_Health_Regulat_Coordination)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Coordination<- Int_Health_Regulat_Coordination %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Coordination",
               names_ptypes = list(year=integer()))

#### Surveillance
Int_Health_Regulat_Surveillance<-Int_Health_Regulat[ ,c(1,18:25)]                                          
colnames(Int_Health_Regulat_Surveillance)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Surveillance<- Int_Health_Regulat_Surveillance %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Surveillance",
               names_ptypes = list(year=integer()))
#### Response
Int_Health_Regulat_Response<-Int_Health_Regulat[ ,c(1,26:33)]
colnames(Int_Health_Regulat_Response)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Response<- Int_Health_Regulat_Response %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Response",
               names_ptypes = list(year=integer()))
#### Preparedness
Int_Health_Regulat_Preparedness<-Int_Health_Regulat[ ,c(1,34:41)]
colnames(Int_Health_Regulat_Preparedness)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Preparedness<- Int_Health_Regulat_Preparedness %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Preparedness",
               names_ptypes = list(year=integer()))
 
#### Risk_communication
Int_Health_Regulat_Risk_communication<-Int_Health_Regulat[ ,c(1,42:49)]
colnames(Int_Health_Regulat_Risk_communication)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Risk_communication<- Int_Health_Regulat_Risk_communication %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Risk_communication",
               names_ptypes = list(year=integer()))

#### Human_resources
Int_Health_Regulat_Human_resources<-Int_Health_Regulat[ ,c(1,50:57)]
colnames(Int_Health_Regulat_Human_resources)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Human_resources<- Int_Health_Regulat_Human_resources %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Human_resources",
               names_ptypes = list(year=integer()))

#### Laboratory
Int_Health_Regulat_Laboratory<-Int_Health_Regulat[ ,c(1,58:65)]
colnames(Int_Health_Regulat_Laboratory)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Laboratory<- Int_Health_Regulat_Laboratory %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Laboratory",
               names_ptypes = list(year=integer()))
#### Points_entry
Int_Health_Regulat_Points_entry<-Int_Health_Regulat[ ,c(1,66:73)]
colnames(Int_Health_Regulat_Points_entry)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Points_entry<- Int_Health_Regulat_Points_entry %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Points_entry",
               names_ptypes = list(year=integer()))
#### Zoonosis
Int_Health_Regulat_Zoonosis<-Int_Health_Regulat[ ,c(1,74:81)]
colnames(Int_Health_Regulat_Zoonosis)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Zoonosis<- Int_Health_Regulat_Zoonosis %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Zoonosis",
               names_ptypes = list(year=integer()))
#### Food_safety
Int_Health_Regulat_Food_safety<-Int_Health_Regulat[ ,c(1,82:89)]
colnames(Int_Health_Regulat_Food_safety)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Food_safety<- Int_Health_Regulat_Food_safety %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Food_safety",
               names_ptypes = list(year=integer()))
#### Chemical
Int_Health_Regulat_Chemical<-Int_Health_Regulat[ ,c(1,90:97)]
colnames(Int_Health_Regulat_Chemical)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Chemical<- Int_Health_Regulat_Chemical %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Chemical",
               names_ptypes = list(year=integer()))

#### Radionuclear
Int_Health_Regulat_Radionuclear<-Int_Health_Regulat[ ,c(1,98:105)]
colnames(Int_Health_Regulat_Radionuclear)<-c("Who_Region","2017","2016","2015","2014","2013","2012","2011","2010")
Int_Health_Regulat_Radionuclear<- Int_Health_Regulat_Radionuclear %>%
  pivot_longer(cols=`2017`:`2010`,
               names_to="year",
               values_to = "Radionuclear",
               names_ptypes = list(year=integer()))
```

#### Fusionando con merge los 13 indicadores. Análisis de la fusión con glimpse, unique and stat.desc

```{r}
m1<-Reduce(function(...) merge(..., all=T), list(Int_Health_Regulat_Legislation,
                                                 Int_Health_Regulat_Coordination,
                                                 Int_Health_Regulat_Surveillance,
                                                 Int_Health_Regulat_Response,
                                                 Int_Health_Regulat_Preparedness,
                                                 Int_Health_Regulat_Risk_communication,
                                                 Int_Health_Regulat_Human_resources,
                                                 Int_Health_Regulat_Laboratory,
                                                 Int_Health_Regulat_Points_entry,
                                                 Int_Health_Regulat_Zoonosis,
                                                 Int_Health_Regulat_Food_safety,
                                                 Int_Health_Regulat_Chemical,
                                                 Int_Health_Regulat_Radionuclear))

glimpse(m1)
unique(m1$Who_Region)
unique(m1$year)
m1_num<-select_if(m1,is.numeric)
stat_m1<-stat.desc(m1_num)
stat_m1<-round(stat_m1,0)
stat_m1


```

#### Fusionando indicador principal con indicadores International_Health_Regulation 
**** Se decide excluir "Global" del indicador principal, porque en el resto de indicadores sólo está para dos años
**** Por tanto, nos quedaríamos con 7 años de evolutivo (2010-2017)
```{r}
Rate_Child_new<-Rate_Child %>% filter(Who_Region != "Global")
m2<-Reduce(function(...) merge (..., all=F), list(Rate_Child_new,m1))
glimpse(m2)
unique(m2$Who_Region)
unique(m2$year)
```

#### Importando 12 ficheros con los Ratios de Mortalidad por causa (variable: <5 años)
**** Sólo nos interesa la variable (0-4 years)
**** Se homogeiniza valores de "Who_Region"

```{r}
#### Asphyxia
Mort_Asphyxia_rate<-read.csv("MORT_Asphyxia_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Asphyxia_rate<-Mort_Asphyxia_rate[ ,c(1:2,5)]
colnames(Mort_Asphyxia_rate)<-c("Who_Region","year","Mort_Asphyxia_rate")

Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "European Region"]<-"Europe"
Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Asphyxia_rate$Who_Region[Mort_Asphyxia_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Asphyxia_rate)
unique(Mort_Asphyxia_rate$Who_Region)

####  Congenital_anom
Mort_Congenital_rate<-read.csv("MORT_Congenital_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Congenital_rate<-Mort_Congenital_rate[ ,c(1:2,5)]
colnames(Mort_Congenital_rate)<-c("Who_Region","year","Mort_Congenital_rate")

Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "European Region"]<-"Europe"
Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Congenital_rate$Who_Region[Mort_Congenital_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Congenital_rate)
unique(Mort_Congenital_rate$Who_Region)

####  Diarrhoeal_diseases

Mort_Diarrhoeal_diseases_rate<-read.csv("MORT_Diarre_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Diarrhoeal_diseases_rate<-Mort_Diarrhoeal_diseases_rate[ ,c(1:2,5)]
colnames(Mort_Diarrhoeal_diseases_rate)<-c("Who_Region","year","Mort_Diarrhoeal_rate")

Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "European Region"]<-"Europe"
Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Diarrhoeal_diseases_rate$Who_Region[Mort_Diarrhoeal_diseases_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Diarrhoeal_diseases_rate)
unique(Mort_Diarrhoeal_diseases_rate$Who_Region)


####  MORT_HIVAIDS_rate

Mort_HIVAIDS_rate<-read.csv("MORT_HIVAIDS_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_HIVAIDS_rate<-Mort_HIVAIDS_rate[ ,c(1:2,5)]
colnames(Mort_HIVAIDS_rate)<-c("Who_Region","year","Mort_HIVAIDS_dis_rate")

Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "European Region"]<-"Europe"
Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_HIVAIDS_rate$Who_Region[Mort_HIVAIDS_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_HIVAIDS_rate)
unique(Mort_HIVAIDS_rate$Who_Region)

#### MORT_Malaria_rate

Mort_Malaria_rate<-read.csv("MORT_Malaria_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Malaria_rate<-Mort_Malaria_rate[ ,c(1:2,5)]
colnames(Mort_Malaria_rate)<-c("Who_Region","year","Mort_Malaria_rate")

Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "European Region"]<-"Europe"
Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Malaria_rate$Who_Region[Mort_Malaria_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Malaria_rate)
unique(Mort_Malaria_rate$Who_Region)

#### MORT_Measles_rate

Mort_Measles_rate<-read.csv("MORT_Measles_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Measles_rate<-Mort_Measles_rate[ ,c(1:2,5)]
colnames(Mort_Measles_rate)<-c("Who_Region","year","Mort_Measles_rate")

Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "European Region"]<-"Europe"
Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Measles_rate$Who_Region[Mort_Measles_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Measles_rate)
unique(Mort_Measles_rate$Who_Region)

#### MORT_Meningitis_rate

Mort_Meningitis_rate<-read.csv("MORT_Meningitis_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Meningitis_rate<-Mort_Meningitis_rate[ ,c(1:2,5)]
colnames(Mort_Meningitis_rate)<-c("Who_Region","year","Mort_Meningitis_rate")

Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "European Region"]<-"Europe"
Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Meningitis_rate$Who_Region[Mort_Meningitis_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Meningitis_rate)
unique(Mort_Meningitis_rate$Who_Region)

#### MORT_Other_rate

Mort_Other_rate<-read.csv("MORT_Other_Nutri_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Other_rate<-Mort_Other_rate[ ,c(1:2,5)]
colnames(Mort_Other_rate)<-c("Who_Region","year","Mort_Other_rate")

Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "European Region"]<-"Europe"
Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Other_rate$Who_Region[Mort_Other_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Other_rate)
unique(Mort_Other_rate$Who_Region)


#### MORT_Prematurity_rate

Mort_Prematurity_rate<-read.csv("MORT_Prematurity_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Prematurity_rate<-Mort_Prematurity_rate[ ,c(1:2,5)]
colnames(Mort_Prematurity_rate)<-c("Who_Region","year","Mort_Prematurity_rate")

Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "European Region"]<-"Europe"
Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Prematurity_rate$Who_Region[Mort_Prematurity_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Prematurity_rate)
unique(Mort_Prematurity_rate$Who_Region)

#### MORT_Respiratory_rate

Mort_Respiratory_rate<-read.csv("MORT_Respiratory_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Respiratory_rate<-Mort_Respiratory_rate[ ,c(1:2,5)]
colnames(Mort_Respiratory_rate)<-c("Who_Region","year","Mort_Respiratory_rate")

Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "European Region"]<-"Europe"
Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Respiratory_rate$Who_Region[Mort_Respiratory_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Respiratory_rate)
unique(Mort_Respiratory_rate$Who_Region)

#### MORT_Sepsis_rate

Mort_Sepsis_rate<-read.csv("MORT_Sepsis_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Sepsis_rate<-Mort_Sepsis_rate[ ,c(1:2,5)]
colnames(Mort_Sepsis_rate)<-c("Who_Region","year","Mort_Sepsis_rate")

Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "European Region"]<-"Europe"
Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Sepsis_rate$Who_Region[Mort_Sepsis_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Sepsis_rate)
unique(Mort_Sepsis_rate$Who_Region)

#### MORT_Tetanos_rate

Mort_Tetanos_rate<-read.csv("MORT_Tetanos_rate.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 2)
Mort_Tetanos_rate<-Mort_Tetanos_rate[ ,c(1:2,5)]
colnames(Mort_Tetanos_rate)<-c("Who_Region","year","Mort_Tetanos_rate")

Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "Africa Region"]<-"Africa" 
Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "Region of the Americas"]<-"Americas"
Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "Eastern Mediterranean Region"]<-"Eastern Mediterranean"
Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "European Region"]<-"Europe"
Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "South-East Asia Region"]<-"South-East Asia"
Mort_Tetanos_rate$Who_Region[Mort_Tetanos_rate$Who_Region == "Western Pacific Region"]<-"Western Pacific"

glimpse(Mort_Tetanos_rate)
unique(Mort_Tetanos_rate$Who_Region)

```



#### Fusionando los 12 indicadores de las causas de Mortalidad Infantil(Rate)

```{r}
m3<-Reduce(function(...) merge(..., all=T), list(Mort_Asphyxia_rate,
                                                 Mort_Congenital_rate,
                                                 Mort_Diarrhoeal_diseases_rate,
                                                 Mort_HIVAIDS_rate,
                                                 Mort_Malaria_rate,
                                                 Mort_Measles_rate,
                                                 Mort_Meningitis_rate,
                                                 Mort_Other_rate,
                                                 Mort_Respiratory_rate,
                                                 Mort_Prematurity_rate,
                                                 Mort_Sepsis_rate,
                                                 Mort_Tetanos_rate))

glimpse(m3)
unique(m3$Who_Region)
unique(m3$year)
m3_num<-select_if(m3,is.numeric)
stat_m3<-stat.desc(m3_num)
stat_m3<-round(stat_m3,0)
stat_m3
```


#### Fusionando tabla principal acumulado con la tabla indicadores "Mort_Cause_Rate""

```{r}
m4<-Reduce(function(...) merge (..., all=F), list(m2,m3))
glimpse(m4)
unique(m4$Who_Region)
unique(m4$year)

```


#### Importando ficheros con los indicadores "Immunization coverage"
**** Se pivota de wide a longer
**** Son nueve en total
```{r}
#### Inm_BCG.csv
Inm_BCG<-read.csv("Inm_BCG.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_BCG<-Inm_BCG[ ,c(1:10)]
colnames(Inm_BCG)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_BCG<- Inm_BCG %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_BCG_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_BCG)
unique(Inm_BCG$Who_Region)
unique(Inm_BCG$year)

#### Inm_DTP3.csv
Inm_DTP3<-read.csv("Inm_DTP3.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_DTP3<-Inm_DTP3[ ,c(1:10)]
colnames(Inm_DTP3)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_DTP3<- Inm_DTP3 %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_DTP3_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_DTP3)
unique(Inm_DTP3$Who_Region)
unique(Inm_DTP3$year)


#### Inm_Hep3.csv
Inm_Hep3<-read.csv("Inm_Hep3.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_Hep3<-Inm_Hep3[ ,c(1:10)]
colnames(Inm_Hep3)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_Hep3<- Inm_Hep3 %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_Hep3_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_Hep3)
unique(Inm_Hep3$Who_Region)
unique(Inm_Hep3$year)

#### Inm_HepB3.csv
Inm_HepB3<-read.csv("Inm_HepB3.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_HepB3<-Inm_HepB3[ ,c(1:10)]
colnames(Inm_HepB3)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_HepB3<- Inm_HepB3 %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_HepB3_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_HepB3)
unique(Inm_HepB3$Who_Region)
unique(Inm_HepB3$year)

#### Inm_MCV1_1st.csv
Inm_MCV1_1st<-read.csv("Inm_MCV1_1st.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_MCV1_1st<-Inm_MCV1_1st[ ,c(1:10)]
colnames(Inm_MCV1_1st)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_MCV1_1st<- Inm_MCV1_1st %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_MCV1_1st_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_MCV1_1st)
unique(Inm_MCV1_1st$Who_Region)
unique(Inm_MCV1_1st$year)

#### Inm_MCV2_2nd.csv
Inm_MCV2_2nd<-read.csv("Inm_MCV2_2nd.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_MCV2_2nd<-Inm_MCV2_2nd[ ,c(1:10)]
colnames(Inm_MCV2_2nd)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_MCV2_2nd<- Inm_MCV2_2nd %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_MCV2_2nd_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_MCV2_2nd)
unique(Inm_MCV2_2nd$Who_Region)
unique(Inm_MCV2_2nd$year)

#### Inm_PCV3.csv
Inm_PCV3<-read.csv("Inm_PCV3.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_PCV3<-Inm_PCV3[ ,c(1:10)]
colnames(Inm_PCV3)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_PCV3<- Inm_PCV3 %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_PCV3_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_PCV3)
unique(Inm_PCV3$Who_Region)
unique(Inm_PCV3$year)

#### Inm_Pol3.csv
Inm_Pol3<-read.csv("Inm_Pol3.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_Pol3<-Inm_Pol3[ ,c(1:10)]
colnames(Inm_Pol3)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_Pol3<- Inm_Pol3 %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_Pol3_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_Pol3)
unique(Inm_Pol3$Who_Region)
unique(Inm_Pol3$year)

#### Inm_ROTAC.csv
Inm_ROTAC<-read.csv("Inm_ROTAC.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
Inm_ROTAC<-Inm_ROTAC[ ,c(1:10)]
colnames(Inm_ROTAC)<-c("Who_Region","2018","2017","2016","2015","2014","2013","2012","2011","2010")

Inm_ROTAC<- Inm_ROTAC %>%
  pivot_longer(cols=`2018`:`2010`,
               names_to="year",
               values_to = "Inm_ROTAC_coverage",
               names_ptypes = list(year=integer()))

glimpse(Inm_ROTAC)
unique(Inm_ROTAC$Who_Region)
unique(Inm_ROTAC$year)
```


#### Fusionando tablas con los indicadores "Inm_Cause_Rate"

```{r}
m5<-Reduce(function(...) merge(..., all=T), list(Inm_BCG,
                                                 Inm_DTP3,
                                                 Inm_Hep3,
                                                 Inm_HepB3,
                                                 Inm_MCV1_1st,
                                                 Inm_MCV2_2nd,
                                                 Inm_PCV3,
                                                 Inm_Pol3,
                                                 Inm_ROTAC))

glimpse(m5)
unique(m5$Who_Region)
unique(m5$year)
m5_num<-select_if(m5,is.numeric)
stat_m5<-stat.desc(m5_num)
stat_m5<-round(stat_m5,0)
stat_m5
```

#### Merge de la tabla principal con la tabla "Inm_Cause_Rate"
**** Total con 37 variables y 48 registros

```{r}
m6<-Reduce(function(...) merge (..., all=F), list(m4,m5))
glimpse(m6)
unique(m6$Who_Region)
unique(m6$year)
m6
```


#### Importando ficheros con los indicadores "Child Malnutrition"
**** Son dos indicadores, las variables contienen el valor y el intervalo de confianza, es de tipo carácter, se extrae el valor y se convierte a numérico
**** En el indicador "ANAEMIA_Children5" se tiene que pivotar la tabla de wide a longer


```{r}
#### Weight_Low_birth
A_Weight_Low_birth<-read.csv("A_Weight_Low_birth.csv",sep=",",header = TRUE,stringsAsFactors = FALSE)
A_Weight_Low_birth<-A_Weight_Low_birth[,c(1:2,4)]
colnames(A_Weight_Low_birth)<-c("Who_Region","year","Low_birth_weight")
A_Weight_Low_birth$Low_birth_weight<-substr(A_Weight_Low_birth$Low_birth_weight,1,4)
A_Weight_Low_birth$Low_birth_weight<-as.numeric(A_Weight_Low_birth$Low_birth_weight)
glimpse(A_Weight_Low_birth)
unique(A_Weight_Low_birth$Who_Region)
unique(A_Weight_Low_birth$year)


#### ANAEMIA_Children5
ANAEMIA_Children5<-read.csv("ANAEMIA_Children5.csv",sep=",",header = TRUE,stringsAsFactors = FALSE,skip = 1)
ANAEMIA_Children5<-ANAEMIA_Children5[,c(1:8)]
colnames(ANAEMIA_Children5)<-c("Who_Region","2016","2015","2014","2013","2012","2011","2010")

ANAEMIA_Children5<- ANAEMIA_Children5 %>%
  pivot_longer(cols=`2016`:`2010`,
               names_to="year",
               values_to = "ANAEMIA_Children5",
               names_ptypes = list(year=integer()))

ANAEMIA_Children5$ANAEMIA_Children5<-substr(ANAEMIA_Children5$ANAEMIA_Children5,1,4)
ANAEMIA_Children5$ANAEMIA_Children5<-as.numeric(ANAEMIA_Children5$ANAEMIA_Children5)
glimpse(ANAEMIA_Children5)
unique(ANAEMIA_Children5$Who_Region)
unique(ANAEMIA_Children5$year)
```

#### Para el indicador "ANAEMIA_Children5" falta el año 2017, se estima por regresión lineal para cada Who_Region.
**** Se genera un ggplot para ver evolutivo
```{r}
ggplot(data=ANAEMIA_Children5,aes(x=year,y=ANAEMIA_Children5))+
  geom_point(aes(col=Who_Region))
```

#### Se genera un "Lineal model" para cada Who_Region para el indicador "ANAEMIA_Children5"
**** Todos los "lm" superan de R2 un 0.9, excepto Europa y América que están entorno al 0.7
```{r}
Anaemia_Africa<-ANAEMIA_Children5 %>% filter(Who_Region== 'Africa')
Anaemia_Americas<-ANAEMIA_Children5 %>% filter(Who_Region== 'Americas')
Anaemia_South_East_Asia<-ANAEMIA_Children5 %>% filter(Who_Region== "South-East Asia")
Anaemia_Europe<-ANAEMIA_Children5 %>% filter(Who_Region== 'Europe')
Anaemia_Eastern_Mediterranean<-ANAEMIA_Children5 %>% filter(Who_Region== 'Eastern Mediterranean')
Anaemia_Western_Pacific<-ANAEMIA_Children5 %>% filter(Who_Region== 'Western Pacific')

model_Africa<-lm(ANAEMIA_Children5~year,data=Anaemia_Africa)
model_Americas<-lm(ANAEMIA_Children5~year,data=Anaemia_Americas)
model_South_East_Asia<-lm(ANAEMIA_Children5~year,data=Anaemia_South_East_Asia)
model_Europe<-lm(ANAEMIA_Children5~year,data=Anaemia_Europe)
model_Eastern_Mediterranean<-lm(ANAEMIA_Children5~year,data=Anaemia_Eastern_Mediterranean)
model_Western_Pacific<-lm(ANAEMIA_Children5~year,data=Anaemia_Western_Pacific)

summary(model_Africa)
summary(model_Americas)
summary(model_South_East_Asia)
summary(model_Europe)
summary(model_Eastern_Mediterranean)
summary(model_Western_Pacific)

newdata<-data.frame(year=c(2017))
pred_Africa<-model_Africa %>% predict(newdata)
pred_Americas<-model_Americas %>% predict(newdata)
pred_South<-model_South_East_Asia %>% predict(newdata)
pred_Europe<-model_Europe %>% predict(newdata)
pred_Eastern<-model_Eastern_Mediterranean %>% predict(newdata)
pred_Western<-model_Western_Pacific %>% predict(newdata)

pred_2017_Anaemia<-data.frame(Who_Region=c("Africa","Americas","South-East Asia","Europe","Eastern Mediterranean","Western Pacific"),
                year=rep(2017,6),
                ANAEMIA_Children5=c(pred_Africa,pred_Americas ,pred_South ,pred_Europe ,pred_Eastern ,pred_Western))
         
pred_2017_Anaemia$ANAEMIA_Children5<-round(pred_2017_Anaemia$ANAEMIA_Children5,1)   
pred_2017_Anaemia$Who_Region<-as.character(pred_2017_Anaemia$Who_Region)
glimpse(pred_2017_Anaemia)
ANAEMIA_Children5<-rbind(ANAEMIA_Children5,pred_2017_Anaemia)
unique(ANAEMIA_Children5$year)

```

#### Para el indicador "Weight_Low_birth" falta el año 2016&2017, se estima por regresión lineal para cada Who_Region.
**** Se genera un ggplot para ver evolutivo

```{r}
ggplot(data=A_Weight_Low_birth,aes(x=year,y=Low_birth_weight))+
  geom_point(aes(col=Who_Region))
```

#### Se genera un "Lineal model" para cada Who_Region
**** Todos los "lm" superan de R2 un 0.9, excepto América que tiene un R2 muy bajo "0.01", porque sus valores tienen poca variabilidad. La estimación que hace es buena porque los valores son muy constantes.

```{r}
Low_birth_weight_Africa<-A_Weight_Low_birth %>% filter(Who_Region== 'Africa')
Low_birth_weight_Americas<-A_Weight_Low_birth %>% filter(Who_Region== 'Americas')
Low_birth_weight_South_East_Asia<-A_Weight_Low_birth %>% filter(Who_Region== "South-East Asia")
Low_birth_weight_Europe<-A_Weight_Low_birth %>% filter(Who_Region== 'Europe')
Low_birth_weight_Eastern_Mediterranean<-A_Weight_Low_birth %>% filter(Who_Region== 'Eastern Mediterranean')
Low_birth_weight_Western_Pacific<-A_Weight_Low_birth %>% filter(Who_Region== 'Western Pacific')

model_Africa<-lm(Low_birth_weight~year,data=Low_birth_weight_Africa)
model_Americas<-lm(Low_birth_weight~year,data=Low_birth_weight_Americas)
model_South_East_Asia<-lm(Low_birth_weight~year,data=Low_birth_weight_South_East_Asia)
model_Europe<-lm(Low_birth_weight~year,data=Low_birth_weight_Europe)
model_Eastern_Mediterranean<-lm(Low_birth_weight~year,data=Low_birth_weight_Eastern_Mediterranean)
model_Western_Pacific<-lm(Low_birth_weight~year,data=Low_birth_weight_Western_Pacific)

summary(model_Africa)
summary(model_Americas)
summary(model_South_East_Asia)
summary(model_Europe)
summary(model_Eastern_Mediterranean)
summary(model_Western_Pacific)

newdata<-data.frame(year=c(2016,2017))
pred_Africa<-model_Africa %>% predict(newdata)
pred_Americas<-model_Americas %>% predict(newdata)
pred_South<-model_South_East_Asia %>% predict(newdata)
pred_Europe<-model_Europe %>% predict(newdata)
pred_Eastern<-model_Eastern_Mediterranean %>% predict(newdata)
pred_Western<-model_Western_Pacific %>% predict(newdata)

pred_2016_17_Low_birth_weight<-data.frame(Who_Region=c(rep("Africa",2),rep("Americas",2),rep("South-East Asia",2),rep("Europe",2),rep("Eastern Mediterranean",2),rep("Western Pacific",2)),
                              year=c(rep(2016:2017,6)),
                              Low_birth_weight=c(pred_Africa,pred_Americas ,pred_South ,pred_Europe ,pred_Eastern ,pred_Western))

pred_2016_17_Low_birth_weight$Low_birth_weight<-round(pred_2016_17_Low_birth_weight$Low_birth_weight,1)
pred_2016_17_Low_birth_weight$Who_Region<-as.character(pred_2016_17_Low_birth_weight$Who_Region)
glimpse(pred_2016_17_Low_birth_weight)

A_Weight_Low_birth<-rbind(A_Weight_Low_birth,pred_2016_17_Low_birth_weight)
A_Weight_Low_birth
```


#### Se actualizan al dataset las estimaciones de estos indicadores
```{r}
m7<-Reduce(function(...) merge (..., all.x=TRUE), list(m6,ANAEMIA_Children5,A_Weight_Low_birth))
glimpse(m7)
unique(m7$Who_Region)
unique(m7$year)

```



#### Analizando valores nulos y NAs del dataset "m7" montado hasta ahora.

```{r}
m7_num<-select_if(m7,is.numeric)
stat_m7<-stat.desc(m7_num)
stat_m7<-round(stat_m7,1)

stat_m7[,(stat_m7["nbr.null",]>0)] #### nos indica las variables con valores Nulls
stat_m7[,(stat_m7["nbr.na",]>0)] #### nos indica las variables con valores NAs

```

#### Se identifican NAs en los siguientes indicadores: Inm_PCV3_coverage & Inm_ROTAC_coverage
#### Identificando las regiones dónde están los NAs y "Analizando" cuál es la mejor estimación.

```{r}
m7$Who_Region[which(is.na(m7$Inm_PCV3_coverage))]
m7$Who_Region[which(is.na(m7$Inm_ROTAC_coverage))]

Inm_PCV3_South_East_Asia<-Inm_PCV3 %>% filter(Inm_PCV3$Who_Region=="South-East Asia" & year>='2015')

ggplot(data=Inm_PCV3_South_East_Asia,aes(x=year,y=Inm_PCV3_coverage))+
  geom_point()  

### Hay que estimar del 2010 a 2014 por regresión lineal para South_East_Asia (se visualiza gráfico con evolutivo)

model_3<-lm(Inm_PCV3_coverage~year, data =Inm_PCV3_South_East_Asia )
summary(model_3)
new_data<-data.frame(year=c(2010,2011,2012,2013,2014))
model_3 %>% predict(new_data) 
#### Cómo el resultado de 2014 ya sale 0, se ponen todos los NAs a 0.

#### Analizando "Eastern Mediterranean" "South-East Asia" para el indicador "Inm_ROTAC", ocurre lo mismo que en el anterior,por tanto, se ponen los NAs a 0 también.

```


#### Cambiando los valores NAs por 0.

```{r}
m7[is.na(m7)]<-0

m7_num<-select_if(m7,is.numeric)
stat_m7<-stat.desc(m7_num)
stat_m7<-round(stat_m7,1)


stat_m7[,(stat_m7["nbr.null",]>0)] #### Se comprueba que los NAs han pasado a "nulls"
stat_m7[,(stat_m7["nbr.na",]>0)] #### Y que en los NAs no sale ninguno ya.

```

#### Se importan indicadores de "Woman an health"
**** Son dos indicadores: 
**** ANAEMIA_RW<-Prevalence of anaemia in women of reproductive age (%)
**** ANAEMIA_PW<- Prevalence of anaemia in pregnant women (%), 
**** Las variables contienen el valor y el intervalo de confianza, es de tipo carácter, se extrae el valor y se convierte a numérico.
**** Se tienen que pivotar las tablas de wide a longer


```{r}
ANAEMIA_RW<-read.csv("ANAEMIA_RW.csv", header=TRUE,sep = ",",stringsAsFactors = FALSE, skip=1)
ANAEMIA_RW<-ANAEMIA_RW[,c(1:8)]
colnames(ANAEMIA_RW)<-c("Who_Region","2016","2015","2014","2013","2012","2011","2010")

ANAEMIA_RW<- ANAEMIA_RW %>%
  pivot_longer(cols=`2016`:`2010`,
               names_to="year",
               values_to = "ANAEMIA_RW",
               names_ptypes = list(year=integer()))

ANAEMIA_RW$ANAEMIA_RW<-substr(ANAEMIA_RW$ANAEMIA_RW,1,4)
ANAEMIA_RW$ANAEMIA_RW<-as.numeric(ANAEMIA_RW$ANAEMIA_RW)
glimpse(ANAEMIA_RW)
unique(ANAEMIA_RW$Who_Region)
unique(ANAEMIA_RW$year)

#### ANAEMIA_PW
ANAEMIA_PW<-read.csv("ANAEMIA_PW.csv", header=TRUE,sep = ",",stringsAsFactors = FALSE, skip=1)
ANAEMIA_PW<-ANAEMIA_PW[,c(1:8)]
colnames(ANAEMIA_PW)<-c("Who_Region","2016","2015","2014","2013","2012","2011","2010")

ANAEMIA_PW<- ANAEMIA_PW %>%
  pivot_longer(cols=`2016`:`2010`,
               names_to="year",
               values_to = "ANAEMIA_PW",
               names_ptypes = list(year=integer()))

ANAEMIA_PW$ANAEMIA_PW<-substr(ANAEMIA_PW$ANAEMIA_PW,1,4)
ANAEMIA_PW$ANAEMIA_PW<-as.numeric(ANAEMIA_PW$ANAEMIA_PW)
glimpse(ANAEMIA_PW)
unique(ANAEMIA_PW$Who_Region)
unique(ANAEMIA_PW$year)
```

#### Se importa indicador:
#### Maternal_mortality<-Maternal mortality ratio (per 100 000 live births)
**** La variable contiene el valor y el intervalo de confianza, es de tipo carácter, se extrae el valor y se convierte a numérico.

```{r}
Maternal_Mort_Rate<-read.csv("Maternal_mortality.csv",header=TRUE,stringsAsFactors = FALSE)
Maternal_Mort_Rate<-Maternal_Mort_Rate[,c(1:3)]
colnames(Maternal_Mort_Rate)<-c("Who_Region", "year", "Maternal_Mort_Rate" )

Maternal_Mort_Rate$Maternal_Mort_Rate<-substr(Maternal_Mort_Rate$Maternal_Mort_Rate,1,3)
Maternal_Mort_Rate$Maternal_Mort_Rate<-as.numeric(Maternal_Mort_Rate$Maternal_Mort_Rate)
glimpse(Maternal_Mort_Rate)
unique(Maternal_Mort_Rate$Who_Region)
unique(Maternal_Mort_Rate$year)
```

#### Se importa "Life expectancy at birth" para ambos sexos.

```{r}
Life_expectancy_All<-read.csv("Life_expectancy_All.csv",header=TRUE,stringsAsFactors = FALSE,skip=1)
Life_expectancy_birth<-Life_expectancy_All[,c(1:3)]
colnames(Life_expectancy_birth)<-c("Who_Region", "year", "Life_expectancy_at_birth" )

glimpse(Life_expectancy_birth)
unique(Life_expectancy_birth$year)
unique(Life_expectancy_birth$Who_Region)
```


#### Se añaden al dataset estos indicadores
ANAEMIA_RW
ANAEMIA_PW
Maternal_Mort_Rate
Life_expectancy_birth

```{r}

dataset<-Reduce(function(...) merge (..., all.x=TRUE), list(m7,ANAEMIA_RW,ANAEMIA_PW,Maternal_Mort_Rate,Life_expectancy_birth))
glimpse(dataset)
unique(dataset$Who_Region)
unique(dataset$year)
```

#### Analizando valores NULOS y NAS del nuevo dataset(ya definitivo, porque no se van a incluir más variables)
**** Se identifican de la variable "Life_Expectancy_at_birth" 30 valores NAs
**** Y de las variables "ANAEMIA_RW" and "ANAEMIA_PW" 6 valores NAs para cada variable

```{r}
dataset_num<-select_if(dataset,is.numeric)
stat_dataset<-stat.desc(dataset_num)
stat_dataset<-round(stat_dataset,1)

stat_dataset[,(stat_dataset["nbr.null",]>0)] #### nos indica las variables con valores Nulls
stat_dataset[,(stat_dataset["nbr.na",]>0)] #### nos indica las variables con valores NAs
```


#### Gráfico del indicador "Life_Expectancy_at_birth" para ver su evolución

```{r}
dataset_Life<-dataset %>% select("Who_Region", year, Life_expectancy_at_birth)
ggplot(data=dataset_Life, aes(x=year, y=Life_expectancy_at_birth))+
  geom_point(aes(col=Who_Region))
```


#### Se decide hacer las estimaciones por regresión lineal

```{r}
Life_Africa<-dataset_Life%>% filter(Who_Region=="Africa")
Life_Americas<-dataset_Life%>% filter(Who_Region=="Americas")
Life_Eastern_Mediterranean<-dataset_Life%>% filter(Who_Region=="Eastern Mediterranean")
Life_Europe<-dataset_Life%>% filter(Who_Region=="Europe")
Life_South_East_Asia<-dataset_Life%>% filter(Who_Region=="South-East Asia")
Life_Western_Pacific<-dataset_Life%>% filter(Who_Region=="Western Pacific")

model_Africa<-lm(Life_expectancy_at_birth~year,data=Life_Africa)
model_Americas<-lm(Life_expectancy_at_birth~year,data=Life_Americas)
model_Eastern_Mediterranean<-lm(Life_expectancy_at_birth~year,data=Life_Eastern_Mediterranean)
model_Europe<-lm(Life_expectancy_at_birth~year,data=Life_Europe)
model_South_East_Asia<-lm(Life_expectancy_at_birth~year,data=Life_South_East_Asia)
model_Western_Pacific<-lm(Life_expectancy_at_birth~year,data=Life_Western_Pacific)

summary(model_Africa)
summary(model_Americas)
summary(model_Eastern_Mediterranean)
summary(model_Europe)
summary(model_South_East_Asia)
summary(model_Western_Pacific)

new_data<-data.frame(year=c(2011,2012,2013,2014,2017))
pred_Africa<-model_Africa %>% predict(new_data)
pred_Americas<-model_Americas %>% predict(new_data)
pred_Eastern_Mediterranean<-model_Eastern_Mediterranean %>% predict(new_data)
pred_Europe<-model_Europe %>% predict(new_data)
pred_South_East_Asia<-model_South_East_Asia %>% predict(new_data)
pred_Western_Pacific<-model_Western_Pacific %>% predict(new_data)

pred_Africa<-data.frame(Who_Region=rep("Africa",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_Africa)
pred_Americas<-data.frame(Who_Region=rep("Americas",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_Americas)
pred_Eastern_Mediterranean<-data.frame(Who_Region=rep("Eastern Mediterranean",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_Eastern_Mediterranean)
pred_Europe<-data.frame(Who_Region=rep("Europe",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_Europe)
pred_South_East_Asia<-data.frame(Who_Region=rep("South-East Asia",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_South_East_Asia)
pred_Western_Pacific<-data.frame(Who_Region=rep("Western Pacific",5),year=c(2011,2012,2013,2014,2017),Life_expectancy_at_birth=pred_Western_Pacific)

pred_Life_all<-data.frame(rbind(pred_Africa,pred_Americas,pred_Eastern_Mediterranean,pred_Europe,pred_South_East_Asia,pred_Western_Pacific))

pred_Life_all$Who_Region<-as.character(pred_Life_all$Who_Region)
pred_Life_all$Life_expectancy_at_birth<-round(pred_Life_all$Life_expectancy_at_birth,1) 
pred_Life_all$year<-as.integer(pred_Life_all$year) 
Life_expectancy_birth<-rbind(Life_expectancy_birth,pred_Life_all)
glimpse(Life_expectancy_birth)
```

####Observando los gráficos se decide estimar 2017 por "regresión lineal" desde el 2013,  
####porque el evolutivo en algunas regiones (en años anteriores) no se comporta de forma lineal

```{r}
dataset_Anaemia<-dataset %>% select(Who_Region,year,ANAEMIA_PW,ANAEMIA_RW)

ggplot(dataset_Anaemia,aes(x=year,y=ANAEMIA_PW))+
  geom_point(aes(col=Who_Region))

ggplot(dataset_Anaemia,aes(x=year,y=ANAEMIA_RW))+
  geom_point(aes(col=Who_Region))


```

#### Estimación por "lm" para el indicador "ANAEMIA_PW"

```{r}
dataset_Anaemia<-dataset %>% select(Who_Region,year,ANAEMIA_PW,ANAEMIA_RW) %>% filter (year >= "2013")

Anaemia_Africa<-dataset_Anaemia%>% filter(Who_Region=="Africa")
Anaemia_Americas<-dataset_Anaemia%>% filter(Who_Region=="Americas")
Anaemia_Eastern_Mediterranean<-dataset_Anaemia%>% filter(Who_Region=="Eastern Mediterranean")
Anaemia_Europe<-dataset_Anaemia%>% filter(Who_Region=="Europe")
Anaemia_South_East_Asia<-dataset_Anaemia%>% filter(Who_Region=="South-East Asia")
Anaemia_Western_Pacific<-dataset_Anaemia%>% filter(Who_Region=="Western Pacific")

model_Africa<-lm(ANAEMIA_PW~year,data=Anaemia_Africa)
model_Americas<-lm(ANAEMIA_PW~year,data=Anaemia_Americas)
model_Eastern_Mediterranean<-lm(ANAEMIA_PW~year,data=Anaemia_Eastern_Mediterranean)
model_Europe<-lm(ANAEMIA_PW~year,data=Anaemia_Europe)
model_South_East_Asia<-lm(ANAEMIA_PW~year,data=Anaemia_South_East_Asia)
model_Western_Pacific<-lm(ANAEMIA_PW~year,data=Anaemia_Western_Pacific)

summary(model_Africa)
summary(model_Americas)
summary(model_Eastern_Mediterranean)
summary(model_Europe)
summary(model_South_East_Asia)
summary(model_Western_Pacific)

new_data<-data.frame(year=c(2017))
pred_Africa<-model_Africa %>% predict(new_data)
pred_Americas<-model_Americas %>% predict(new_data)
pred_Eastern_Mediterranean<-model_Eastern_Mediterranean %>% predict(new_data)
pred_Europe<-model_Europe %>% predict(new_data)
pred_South_East_Asia<-model_South_East_Asia %>% predict(new_data)
pred_Western_Pacific<-model_Western_Pacific %>% predict(new_data)


pred_Africa<-data.frame(Who_Region=c("Africa"),year=c(2017),ANAEMIA_PW=pred_Africa)
pred_Americas<-data.frame(Who_Region=c("Americas"),year=c(2017),ANAEMIA_PW=pred_Americas)
pred_Eastern_Mediterranean<-data.frame(Who_Region=c("Eastern Mediterranean"),year=c(2017),ANAEMIA_PW=pred_Eastern_Mediterranean)
pred_Europe<-data.frame(Who_Region=c("Europe"),year=c(2017),ANAEMIA_PW=pred_Europe)
pred_South_East_Asia<-data.frame(Who_Region=c("South-East Asia"),year=c(2017),ANAEMIA_PW=pred_South_East_Asia)
pred_Western_Pacific<-data.frame(Who_Region=c("Western Pacific"),year=c(2017),ANAEMIA_PW=pred_Western_Pacific)

pred_Anaemia_PW<-data.frame(rbind(pred_Africa,pred_Americas,pred_Eastern_Mediterranean,pred_Europe,pred_South_East_Asia,pred_Western_Pacific))

pred_Anaemia_PW$Who_Region<-as.character(pred_Anaemia_PW$Who_Region)
pred_Anaemia_PW$ANAEMIA_PW<-round(pred_Anaemia_PW$ANAEMIA_PW,1) 
pred_Anaemia_PW$year<-as.integer(pred_Anaemia_PW$year) 
ANAEMIA_PW<-rbind(ANAEMIA_PW,pred_Anaemia_PW)
glimpse(ANAEMIA_PW)
```


#### Estimación por "lm" para el indicador "ANAEMIA_RW"
**** Todas las Regiones superan el R2 de 0.92, excepto "Africa" que obtiene un R2 muy bajo (0.16), pero se observa que la estimación que realiza no es mala, porque los valores no tienen mucha variablidad, por tanto, se utiliza ésta.

```{r}
model_Africa<-lm(ANAEMIA_RW~year,data=Anaemia_Africa)
model_Americas<-lm(ANAEMIA_RW~year,data=Anaemia_Americas)
model_Eastern_Mediterranean<-lm(ANAEMIA_RW~year,data=Anaemia_Eastern_Mediterranean)
model_Europe<-lm(ANAEMIA_RW~year,data=Anaemia_Europe)
model_South_East_Asia<-lm(ANAEMIA_RW~year,data=Anaemia_South_East_Asia)
model_Western_Pacific<-lm(ANAEMIA_RW~year,data=Anaemia_Western_Pacific)

summary(model_Africa)
summary(model_Americas)
summary(model_Eastern_Mediterranean)
summary(model_Europe)
summary(model_South_East_Asia)
summary(model_Western_Pacific)

new_data<-data.frame(year=c(2017))
pred_Africa<-model_Africa %>% predict(new_data)
pred_Americas<-model_Americas %>% predict(new_data)
pred_Eastern_Mediterranean<-model_Eastern_Mediterranean %>% predict(new_data)
pred_Europe<-model_Europe %>% predict(new_data)
pred_South_East_Asia<-model_South_East_Asia %>% predict(new_data)
pred_Western_Pacific<-model_Western_Pacific %>% predict(new_data)


pred_Africa<-data.frame(Who_Region=c("Africa"),year=c(2017),ANAEMIA_RW=pred_Africa)
pred_Americas<-data.frame(Who_Region=c("Americas"),year=c(2017),ANAEMIA_RW=pred_Americas)
pred_Eastern_Mediterranean<-data.frame(Who_Region=c("Eastern Mediterranean"),year=c(2017),ANAEMIA_RW=pred_Eastern_Mediterranean)
pred_Europe<-data.frame(Who_Region=c("Europe"),year=c(2017),ANAEMIA_RW=pred_Europe)
pred_South_East_Asia<-data.frame(Who_Region=c("South-East Asia"),year=c(2017),ANAEMIA_RW=pred_South_East_Asia)
pred_Western_Pacific<-data.frame(Who_Region=c("Western Pacific"),year=c(2017),ANAEMIA_RW=pred_Western_Pacific)

pred_Anaemia_RW<-data.frame(rbind(pred_Africa,pred_Americas,pred_Eastern_Mediterranean,pred_Europe,pred_South_East_Asia,pred_Western_Pacific))

pred_Anaemia_RW$Who_Region<-as.character(pred_Anaemia_RW$Who_Region)
pred_Anaemia_RW$ANAEMIA_RW<-round(pred_Anaemia_RW$ANAEMIA_RW,1) 
pred_Anaemia_RW$year<-as.integer(pred_Anaemia_RW$year) 
ANAEMIA_RW<-rbind(ANAEMIA_RW,pred_Anaemia_RW)
glimpse(ANAEMIA_RW)
```

#### Actualizando los valores estimados en el "dataset"

```{r}
dataset<-dataset %>% select(-Life_expectancy_at_birth,-ANAEMIA_RW,-ANAEMIA_PW) ## por error reiterativo en el merge siguiente, se decide incluir esta línea de comandos para solucionarlo.
dataset<-Reduce(function(...) merge (..., all.x=TRUE), list(dataset,ANAEMIA_RW,ANAEMIA_PW,Life_expectancy_birth))
glimpse(dataset)
unique(dataset$Who_Region)
unique(dataset$year)
```

#### Verificando estadísticas del dataset y los valores Nulls & NAs
```{r}
dataset_num<-select_if(dataset,is.numeric)
stat_dataset<-stat.desc(dataset_num)
stat_dataset<-round(stat_dataset,1)
stat_dataset

stat_dataset[,(stat_dataset["nbr.null",]>0)] #### nos indica las variables con valores Nulls
stat_dataset[,(stat_dataset["nbr.na",]>0)] #### nos indica las variables con valores NAs
```

#### REGRESION PENALIZADA "CRESTA"
#### Se utiliza CV K-fold(5)
#### Train: Se estandarizan los datos con "scale=TRUE"


```{r}
set.seed(123)
training_samples<-dataset$Rate_Mort_Child %>%
  createDataPartition(p=0.8,list=FALSE)
train_data<-dataset[training_samples,]
test_data<-dataset[-training_samples,]

lambda<-10^seq(-3,3,length=100)
set.seed(123)
model_ridge<- train(
  Rate_Mort_Child~.,data=train_data,method="glmnet",
  trControl=trainControl("cv",number=5),
  scale=TRUE,
  tuneGrid=expand.grid(alpha=0,lambda=lambda)
)
coef(model_ridge$finalModel,model_ridge$bestTune$lambda)
```

#### Métricas resultado "Cross-Validation k-fold" para "Cresta"
```{r}
Metricas_train_ridge<-data.frame("metrics_train_ridge",Median_RMSE=median(model_ridge$resample$RMSE),
Median_MAE=median(model_ridge$resample$MAE),
Median_RSquared=median(model_ridge$resample$Rsquared)) 

Metricas_train_ridge
```

#### Métricas de las predicciones para test.
```{r}

predictions_ridge<-model_ridge %>% predict(test_data)
Metricas_ridge_test<-data.frame("metrics_test_ridge",
  RMSE=RMSE(predictions_ridge,test_data$Rate_Mort_Child),
  MAE=MAE(predictions_ridge,test_data$Rate_Mort_Child),
  Rsquare=caret::R2(predictions_ridge,test_data$Rate_Mort_Child)
)
Metricas_ridge_test
```


#### REGRESION PENALIZADA "LASSO"
#### Se utiliza CV K-fold(5)
#### Train: Se estandarizan los datos con "scale=TRUE"

```{r}
lambda<-10^seq(-3,3,length=100)
set.seed(123)
model_lasso<- train(
  Rate_Mort_Child~.,data=train_data,method="glmnet",
  trControl=trainControl("cv",number=5),
  scale=TRUE,
  tuneGrid=expand.grid(alpha=1,lambda=lambda)
)
coef(model_lasso$finalModel,model_lasso$bestTune$lambda)
```

#### Métricas resultado "Cross-Validation k-fold" para "Lasso"
```{r}
Metricas_train_lasso<-data.frame("metrics_train_lasso",Median_RMSE=median(model_lasso$resample$RMSE),
Median_MAE=median(model_lasso$resample$MAE),
Median_RSquared=median(model_lasso$resample$Rsquared)) 

Metricas_train_lasso
```



#### Métricas de las predicciones para test.
```{r}
predictions_lasso<-model_lasso %>% predict(test_data)
Metricas_lasso_test<-data.frame("metrics_test_lasso",
  RMSE=RMSE(predictions_lasso,test_data$Rate_Mort_Child),
  MAE=MAE(predictions_lasso,test_data$Rate_Mort_Child),
  Rsquare=caret::R2(predictions_lasso,test_data$Rate_Mort_Child)
)
Metricas_lasso_test
```


#### REGRESION PENALIZADA "NET ELASTIC"
#### Se utiliza CV K-fold(5)
#### Train: Se estandarizan los datos con "scale=TRUE"

```{r}
lambda<-10^seq(-3,3,length=100)
set.seed(123)
model_elastic<- train(
  Rate_Mort_Child~.,data=train_data,method="glmnet",
  trControl=trainControl("cv",number=5),
  scale=TRUE,
  tuneLength=10
)
coef(model_elastic$finalModel,model_elastic$bestTune$lambda)
```

#### Métricas resultado "Cross-Validation k-fold" para "Net Elastic"
```{r}
Metricas_train_elastic<-data.frame("metrics_train_elastic",Median_RMSE=median(model_elastic$resample$RMSE),
Median_MAE=median(model_elastic$resample$MAE),
Median_RSquared=median(model_elastic$resample$Rsquared)) 

Metricas_train_elastic
```



#### Métricas de las predicciones para test.
```{r}
predictions_elastic<-model_elastic %>% predict(test_data)
Metricas_elastic_test<-data.frame("metrics_test_elastic",
  RMSE=RMSE(predictions_elastic,test_data$Rate_Mort_Child),
  MAE=MAE(predictions_elastic,test_data$Rate_Mort_Child),
  Rsquare=caret::R2(predictions_elastic,test_data$Rate_Mort_Child)
)
Metricas_elastic_test
```



#### COMPARATIVA RENDIMIENTO DEL MODELO "MEDIANA DE LAS MÉTRICAS" en "Cross validation k-fold"(train/validation)

```{r}
models<-list(model_ridge=model_ridge,model_lasso=model_lasso,model_elastic=model_elastic)

Metricas_train_model<-resamples(models) %>% summary(perfNames="")

met_train<-data.frame(cbind(Median_RMSE=((Metricas_train_model$statistics$RMSE)[,3]),
                     Median_MAE=((Metricas_train_model$statistics$MAE)[,3]),
                     Median_Rsquared=((Metricas_train_model$statistics$Rsquared)[,3])))

type_model<-rownames(met_train)
met_train<-data.frame(type_model,Median_RMSE=round(met_train$Median_RMSE,4),
                      Median_MAE=round(met_train$Median_MAE,4),
                      Median_Rsquared=round(met_train$Median_Rsquared,4))
met_train
met_longer <- met_train%>%
  pivot_longer(cols=`Median_RMSE`:"Median_Rsquared",
               names_to="nom_met",
               values_to = "valor_met")

ggplot(data=met_longer,aes(x=nom_met,y=valor_met,fill=type_model))+
  geom_bar(stat="identity",position=position_dodge())+
  xlab("Métricas")+
  ylab("valores")+
  geom_text(aes(label=valor_met), position=position_dodge(width=0.9), vjust=2,size=2)

```


#### COMPARATIVA MÉTRICAS "MODEL PREDICTION PERFORMANCE" (TEST)

```{r}
met_test<-data.frame(rbind(Ridge_test=round(Metricas_ridge_test[,2:4],4),
                 Lasso_test=round(Metricas_lasso_test[,2:4],4),
                 Elastic_test=round(Metricas_elastic_test[,2:4],4)
                 ))

met_test
type_model<-rownames(met_test)
met_test<-data.frame(type_model,RMSE=met_test$RMSE,
                     MAE=met_test$MAE,
                     RSquare=met_test$Rsquare)

met_longer <- met_test %>%
  pivot_longer(cols=`RMSE`:`RSquare`,
               names_to="nom_met",
               values_to = "valor_met")

ggplot(data=met_longer,aes(x=nom_met,y=valor_met,fill=type_model))+
  geom_bar(stat="identity",position=position_dodge())+
  xlab("Métricas")+
  ylab("valores")+
  geom_text(aes(label=valor_met), position=position_dodge(width=0.9), vjust=2,size=2)
```



#### Análisis de los supuestos de Regresión lineal con "lm" para las variables identificadas por Lasso
**** 1.-Linealidad de los datos-> Gráfica Residual vs Fitted-> 

Se utiliza para verificar los supuestos de relación lineal.Una línea horizontal sin patrones distintos, es una indicación de una relación lineal. En nuestro caso,prácticamente se mueve entorno a 0, es decir, asumimos linealidad entre predictores y variable resultado.

**** 2.-Normalidad de los residuos-> Gráfica Normal Q-Q-> 
  
Se utiliza para examinar si los residuos se distribuyen normalmente. Es bueno si los puntos residuales siguen la linea recta discontinua.En nuestro caso la mayoría siguen la línea, excepto los valores atípicos y algunos puntuales.
  
**** 3.-Homogeneidad de la varianza residual(homocedasticidad)-> Gráfica Scale-Location-> 
La línea horizontal con puntos igualmente extendidos es una buena indicación de              homocedasticidad.En nuestros caso el comportamiento es de poca variación (entorno 0.5),       por tanto, asumimos "homocedasticidad"

**** 4.-Independencia de los términos de error de residuos. -> Gráfica        Scale-Location->  
**** 5.-Gráfico Residuals vs Leverage-> Se utiliza para identificar casos influyentes. 

    Valores atípicos-> Las observaciones cuyos residuos estandarizados son mayores que 3 en  valor absoluto son posibles valores atípicos.
En nuestro caso resaltan 3 puntos más extremos(#1,#9,#34),con resdiduos estandarizados por debajo de 3, excepto el#9 (4.09)
      
    Puntos de apalacamiento-> Se puede detectar examinando la estadistica de ".hat". Un valor superior a 2(p+1)/n indicaría una observación con alto apalancamiento.En nuestro caso 2(43+1)/40=1.15. No supera ningún valor el 0,45.
      
      Valores influyentes-> Es un valor cuya inclusión o exclusión altera los resultados del análisis de regresión. No todos los valores atípicos influyen en el análisis de regresión. La "distancia de Cook" determina la influencia de un valor. Esta métrica define la influencia como una combinación de apalancamiento y tamaño residual. En nuestro caso ningun punto es influyente, porque están dentro de los límites marcados por la distancia de Cook.
```{r}
lm_model_lasso<-lm(Rate_Mort_Child~Mort_Congenital_rate + Mort_Diarrhoeal_rate+
     Mort_Meningitis_rate+Mort_Other_rate+
     Mort_Respiratory_rate+Life_expectancy_at_birth, data=train_data)
summary(lm_model_lasso)  

par(mar=c(2,2,2,2))
plot(lm_model_lasso,1)
plot(lm_model_lasso,2)
plot(lm_model_lasso,3)
plot(lm_model_lasso,4)
plot(lm_model_lasso,5)



```




#### Se decide excluir el registro #9 (valor atípico para ver el comportamiento del "lineal model"), también quitamos la variable "Mort_Meningitis_Rate" por ser poco significativa, y veremos el comportamiento:
```{r}
#### Tabla con las métricas del diagnóstico
model_diag_metrics<-augment(lm_model_lasso)
model_diag_metrics

#### Identificando los tres valores extremos
top_3_cook<-model_diag_metrics %>%
  top_n(3,wt=.cooksd)
top_3_cook

#train_data[which(rownames(train_data)==1),]
#Excluyendo los valores extremos del dataset train_data
train_data_exc<-train_data %>% filter(Rate_Mort_Child!=19.4)
glimpse(train_data_exc)

#### Aplicando "lm"
lm_model_lasso_exc<-lm(Rate_Mort_Child~Mort_Congenital_rate + Mort_Diarrhoeal_rate+
                Mort_Other_rate+
                Mort_Respiratory_rate+Life_expectancy_at_birth, data=train_data_exc)
summary(lm_model_lasso_exc)  

par(mar=c(2,2,2,2))
plot(lm_model_lasso_exc,1)
plot(lm_model_lasso_exc,2)
plot(lm_model_lasso_exc,3)
plot(lm_model_lasso_exc,4)
plot(lm_model_lasso_exc,5)
```

#### STEPWISE-leapBackward 

```{r}
set.seed(123)
train_control<-trainControl(method = "cv",number=5)
step_model_Back<-train(Rate_Mort_Child~.,data=train_data,
                  method="leapBackward",
                  tuneGrid=data.frame(nvmax=1:5),
                  trControl=train_control,
                  scale=TRUE)

warnings()
step_model_Back$results
step_model_Back$bestTune
coef_step_Back<-coef(step_model_Back$finalModel,5)
data.frame(round(coef_step_Back,3))

predictions_leap_Back<-step_model_Back %>% predict(test_data)

Metricas_leap_Back<-data.frame(Metrics="metrics_test_leap_Back",
RMSE=RMSE(predictions_leap_Back,test_data$Rate_Mort_Child),
MAE=MAE(predictions_leap_Back,test_data$Rate_Mort_Child),
RSquared=caret::R2(predictions_leap_Back,test_data$Rate_Mort_Child))
  
Metricas_leap_Back

```


#### STEPWISE-leapForward 

```{r}
set.seed(123)
train_control<-trainControl(method = "cv",number=5)
step_model_Forward<-train(Rate_Mort_Child~.,data=train_data,
                  method="leapForward",
                  tuneGrid=data.frame(nvmax=1:5),
                  trControl=train_control,
                  scale=TRUE)

step_model_Forward$results
step_model_Forward$bestTune
coef_leap_Forward<-coef(step_model_Forward$finalModel,5)
data.frame(round(coef_leap_Forward,3))

predictions_leap_Forward<-step_model_Forward %>% predict(test_data)

Metricas_leap_Forward<-data.frame(Metrics="metrics_test_leap_Forward",
RMSE=RMSE(predictions_leap_Forward,test_data$Rate_Mort_Child),
MAE=MAE(predictions_leap_Forward,test_data$Rate_Mort_Child),
RSquared=caret::R2(predictions_leap_Forward,test_data$Rate_Mort_Child))
  
Metricas_leap_Forward

```



#### STEPWISE-leapSeq 

```{r}
set.seed(345)
train_control<-trainControl(method = "cv",number=5)
step_model_Seq<-train(Rate_Mort_Child~.,data=train_data,
                  method="leapSeq",
                  tuneGrid=data.frame(nvmax=1:5),
                  trControl=train_control,
                  scale=TRUE)
step_model_Seq$results
step_model_Seq$bestTune

coef_Leap_Seq<-coef(step_model_Seq$finalModel,4)
data.frame(round(coef_Leap_Seq,3))


predictions_leap_Seq<-step_model_Seq %>% predict(test_data)

Metricas_leap_Seq<-data.frame(Metrics="metrics_test_leap_seq",
  RMSE=RMSE(predictions_leap_Seq,test_data$Rate_Mort_Child),
  MAE=MAE(predictions_leap_Seq,test_data$Rate_Mort_Child),
  RSquared=caret::R2(predictions_leap_Seq,test_data$Rate_Mort_Child)
)
Metricas_leap_Seq
```


```{r}
rbind(Train_Step_Backward=step_model_Back$results[5,c(2,4,3)],
Train_Step_Forward=step_model_Forward$results[5,c(2,4,3)],
Train_Step_Seq=step_model_Seq$results[5,c(2,4,3)])

```


```{r}
rbind(Metricas_leap_Back,
      Metricas_leap_Forward,
      Metricas_leap_Seq)


```

```{r}
lm_model_Forward<-lm(Rate_Mort_Child~Response+Mort_Congenital_rate+
     Mort_Diarrhoeal_rate+Mort_Other_rate+Inm_PCV3_coverage, data=train_data)
summary(lm_model_Forward)
plot(lm_model_Forward)
```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
